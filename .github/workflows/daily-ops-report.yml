name: Daily Ops Report

on:
  schedule:
    # 06:10 UTC daily (after the Toronto day boundary)
    - cron: '10 6 * * *'
  workflow_dispatch:
    inputs:
      report_date:
        description: 'Report date (YYYY-MM-DD). Defaults to today in locked metro timezone.'
        required: false
      activity_date:
        description: 'Activity date (YYYY-MM-DD). Defaults to report_date - 1 day in locked metro timezone.'
        required: false
      outreaches:
        description: 'Manual outreach count for the activity date.'
        required: false
      follow_ups:
        description: 'Manual follow-up count for the activity date.'
        required: false

concurrency:
  group: daily-ops-report
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  daily-report:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 20
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      INPUT_REPORT_DATE: ${{ github.event.inputs.report_date || '' }}
      INPUT_ACTIVITY_DATE: ${{ github.event.inputs.activity_date || '' }}
      INPUT_OUTREACHES: ${{ github.event.inputs.outreaches || '' }}
      INPUT_FOLLOW_UPS: ${{ github.event.inputs.follow_ups || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Generate daily ops report
        id: generate
        shell: bash
        run: |
          set +e
          args=()
          if [ -n "$INPUT_REPORT_DATE" ]; then
            args+=(--report_date "$INPUT_REPORT_DATE")
          fi
          if [ -n "$INPUT_ACTIVITY_DATE" ]; then
            args+=(--activity_date "$INPUT_ACTIVITY_DATE")
          fi
          if [ -n "$INPUT_OUTREACHES" ]; then
            args+=(--outreaches "$INPUT_OUTREACHES")
          fi
          if [ -n "$INPUT_FOLLOW_UPS" ]; then
            args+=(--follow_ups "$INPUT_FOLLOW_UPS")
          fi

          npm run ops:daily-report -- "${args[@]}"
          report_exit=$?
          echo "report_exit=$report_exit" >> "$GITHUB_OUTPUT"
          echo "Daily report exit code: $report_exit"
          exit 0

      - name: Commit and push report artifact
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "$(git status --porcelain docs/ops/daily)" ]; then
            echo "No daily report changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/ops/daily
          commit_date="$(date -u +%F)"
          git commit -m "chore(ops): daily report ${commit_date} [skip ci]"
          git push origin HEAD:master

      - name: Set final job status from generator
        if: always()
        shell: bash
        run: |
          code="${{ steps.generate.outputs.report_exit }}"
          if [ -z "$code" ]; then
            echo "Missing generator exit code output."
            exit 1
          fi

          if [ "$code" = "0" ]; then
            echo "Daily report completed successfully."
            exit 0
          fi

          if [ "$code" = "2" ]; then
            echo "Daily report is BLOCKED (expected non-green status)."
            exit 2
          fi

          echo "Daily report failed with unexpected exit code: $code"
          exit "$code"
